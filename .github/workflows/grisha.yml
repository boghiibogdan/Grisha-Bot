name: Grisha Scheduler

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"   # Daily 07:00 UTC
    - cron: "0 18 * * 0"  # Sunday 18:00 UTC

jobs:
  run-grisha:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Grisha (daily or weekly)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
          RUN_MODE: daily
        run: |
          # If it's Sunday 18:00 UTC, send weekly; otherwise send daily
          python - <<'PY'
          from datetime import datetime, timezone
          now = datetime.now(timezone.utc)
          is_weekly = (now.weekday() == 6 and now.hour == 18)
          print("weekly" if is_weekly else "daily")
          PY > mode.txt

          export RUN_MODE=$(cat mode.txt)
          echo "RUN_MODE=$RUN_MODE"
          python grisha.py
